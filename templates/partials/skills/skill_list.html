<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF--8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skills Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      #skillModal,
      #user-menu {
        transition: opacity 0.3s ease-in-out;
      }
      #modalContent {
        transition: transform 0.3s ease-in-out;
      }
    </style>
  </head>
  <body class="bg-slate-50 font-sans">
    <div class="flex h-screen">
      {% include 'partials/sidebar.html' %}

      <div class="flex-1 flex flex-col overflow-hidden">
        {% include 'partials/header.html' with page_title="" %}
        <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
          <header
            class="flex flex-col sm:flex-row justify-between items-center mb-8"
          >
            <h1
              class="text-3xl md:text-4xl font-bold text-slate-800 mb-4 sm:mb-0"
            >
              Skills
            </h1>
            <button
              id="addSkillBtn"
              class="w-full sm:w-auto bg-[#736B8E] text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-[#625a7a] focus:outline-none focus:ring-2 focus:ring-[#736B8E] focus:ring-opacity-50 transition duration-300"
            >
              Add New Skill
            </button>
          </header>

          <div id="skillsList" class="space-y-3">
            {% for skill in skills %}
            <div
              class="skill-item bg-white flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 rounded-lg shadow-sm transition-all duration-300"
              data-skill-id="{{ skill.id }}"
              data-skill-name="{{ skill.name }}"
              data-is-active="{{ skill.is_active|yesno:'true,false' }}"
            >
              <span
                class="skill-name-text text-lg text-slate-700 font-medium mb-3 sm:mb-0"
                >{{ skill.name }}</span
              >
              <div class="flex space-x-3">
                <button
                  class="edit-btn bg-[#9a92b2] text-white text-sm font-medium py-2 px-5 rounded-lg hover:bg-[#8981a1] transition duration-300"
                >
                  Edit
                </button>
                <button
                  class="delete-btn bg-slate-200 text-slate-700 text-sm font-medium py-2 px-5 rounded-lg hover:bg-slate-300 transition duration-300"
                >
                  Delete
                </button>
              </div>
            </div>
            {% empty %}
            <div class="bg-white text-center p-8 rounded-lg shadow-sm">
              <p class="text-slate-500">
                No skills found. Click 'Add New Skill' to get started!
              </p>
            </div>
            {% endfor %}
          </div>
        </main>
      </div>
    </div>

    <div
      id="skillModal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4 opacity-0 pointer-events-none"
    >
      <div
        id="modalContent"
        class="bg-white w-full max-w-md p-6 sm:p-8 rounded-xl shadow-2xl transform scale-95"
      >
        <h2 id="modalTitle" class="text-2xl font-bold text-[#736B8E] mb-6">
          Add New Skill
        </h2>
        <form id="skillForm" novalidate>
          {% csrf_token %}
          <input type="hidden" id="skillId" name="skillId" />
          <div class="mb-5">
            <label
              for="skillName"
              class="block text-sm font-medium text-slate-600 mb-2"
              >Name <span class="text-red-500">*</span></label
            >
            <input
              type="text"
              id="skillName"
              name="name"
              placeholder="Enter Skill Name"
              class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#736B8E] transition"
              required
            />
            <p id="skill-name-error" class="text-red-500 text-sm mt-1"></p>
          </div>
          <div class="mb-8">
            <label class="flex items-center cursor-pointer">
              <input
                type="checkbox"
                id="isActive"
                name="is_active"
                class="h-4 w-4 rounded border-slate-300 text-[#736B8E] focus:ring-[#625a7a]"
                checked
              />
              <span class="ml-3 text-sm text-slate-700 select-none"
                >is Active</span
              >
            </label>
          </div>
          <div class="flex justify-end space-x-4">
            <button
              type="button"
              id="cancelBtn"
              class="bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-lg hover:bg-slate-300 transition duration-300"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="bg-[#736B8E] text-white font-semibold py-2 px-5 rounded-lg shadow-md hover:bg-[#625a7a] transition duration-300"
            >
              Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        // --- Sidebar Toggle Logic ---
        const sidebar = document.getElementById("sidebar");
        const toggleButton = document.getElementById("sidebar-toggle");
        const sidebarLogo = document.getElementById("sidebar-logo");
        const sidebarTexts = document.querySelectorAll(".sidebar-text");
        const sidebarHeader = document.getElementById("sidebar-header");

        if (sidebar && toggleButton) {
          toggleButton.addEventListener("click", () => {
            sidebar.classList.toggle("w-64"); // Full width
            sidebar.classList.toggle("w-20"); // Collapsed width

            // Hide/show text and logo
            if (sidebarLogo) sidebarLogo.classList.toggle("hidden");
            if (sidebarTexts)
              sidebarTexts.forEach((text) => text.classList.toggle("hidden"));

            // Adjust header alignment
            if (sidebarHeader) {
              sidebarHeader.classList.toggle("justify-between");
              sidebarHeader.classList.toggle("justify-center");
            }
          });
        }
        const csrftoken = getCookie("csrftoken");

        const addSkillBtn = document.getElementById("addSkillBtn");
        const skillModal = document.getElementById("skillModal");
        const modalContent = document.getElementById("modalContent");
        const modalTitle = document.getElementById("modalTitle");
        const cancelBtn = document.getElementById("cancelBtn");
        const skillForm = document.getElementById("skillForm");
        const skillsList = document.getElementById("skillsList");
        const skillIdInput = document.getElementById("skillId");
        const skillNameInput = document.getElementById("skillName");
        const isActiveInput = document.getElementById("isActive");
        const nameError = document.getElementById("skill-name-error");

        const openModal = (mode = "add", skill = null) => {
          skillForm.reset();
          skillIdInput.value = "";
          nameError.textContent = "";
          skillNameInput.classList.remove("border-red-500");
          if (mode === "edit" && skill) {
            modalTitle.textContent = "Edit Skill";
            skillIdInput.value = skill.id;
            skillNameInput.value = skill.name;
            isActiveInput.checked = skill.isActive;
          } else {
            modalTitle.textContent = "Add New Skill";
            isActiveInput.checked = true;
          }
          skillModal.classList.remove("opacity-0", "pointer-events-none");
          modalContent.classList.remove("scale-95");
          skillNameInput.focus();
        };

        const closeModal = () => {
          modalContent.classList.add("scale-95");
          skillModal.classList.add("opacity-0");
          setTimeout(() => {
            skillModal.classList.add("pointer-events-none");
          }, 300);
        };

        addSkillBtn.addEventListener("click", () => openModal("add"));
        cancelBtn.addEventListener("click", closeModal);
        skillModal.addEventListener("click", (e) => {
          if (e.target === skillModal) closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

        skillForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const id = skillIdInput.value;
          const name = skillNameInput.value.trim();
          const is_active = isActiveInput.checked;

          const url = id ? `/skills/update/${id}/` : "{% url 'skill_create' %}";

          fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({ name, is_active }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                location.reload();
              } else {
                nameError.textContent = data.errors.name[0];
                skillNameInput.classList.add("border-red-500");
              }
            })
            .catch((error) => console.error("Error:", error));
        });

        skillsList.addEventListener("click", (e) => {
          const skillItem = e.target.closest(".skill-item");
          if (!skillItem) return;
          const skillId = skillItem.dataset.skillId;

          if (e.target.classList.contains("edit-btn")) {
            const skill = {
              id: skillId,
              name: skillItem.dataset.skillName,
              isActive: skillItem.dataset.isActive === "true",
            };
            openModal("edit", skill);
          }

          if (e.target.classList.contains("delete-btn")) {
            if (confirm("Are you sure you want to delete this skill?")) {
              fetch(`/skills/delete/${skillId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken },
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.status === "success") {
                    skillItem.style.transition =
                      "opacity 0.3s ease, transform 0.3s ease";
                    skillItem.style.opacity = "0";
                    skillItem.style.transform = "translateX(20px)";
                    setTimeout(() => {
                      skillItem.remove();
                    }, 300);
                  } else {
                    alert(data.message || "Failed to delete skill.");
                  }
                })
                .catch((error) => console.error("Error:", error));
            }
          }
        });

        // User menu toggle
        const userMenuButton = document.getElementById("user-menu-button");
        const userMenu = document.getElementById("user-menu");
        if (userMenuButton && userMenu) {
          userMenuButton.addEventListener("click", () =>
            userMenu.classList.toggle("hidden")
          );
          document.addEventListener("click", (e) => {
            if (
              !userMenu.classList.contains("hidden") &&
              !userMenuButton.contains(e.target)
            ) {
              userMenu.classList.add("hidden");
            }
          });
        }
      });
    </script>
  </body>
</html>
