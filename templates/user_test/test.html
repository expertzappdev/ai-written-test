{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assessment: {{ paper.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />


    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/2.0.0/skulpt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/2.0.0/skulpt-stdlib.min.js"></script>

    <script>
      /*
       * DEDICATED WINDOW LOGIC:
       * Opens test in a new window and tries to close the original window immediately.
       */
      (function () {
        const windowName = "dedicatedAssessmentWindow";

        // Check if the window is already the dedicated one and not a temporary opener.
        if (window.name !== windowName && !window.opener) {
          const url = window.location.href;

          // Open a new, dedicated window.
          const newWindow = window.open(
            url,
            windowName,
            "width=" +
              screen.availWidth +
              ",height=" +
              screen.availHeight +
              ",resizable=yes,scrollbars=yes,location=no,menubar=no,toolbar=no,status=no"
          );
      /*
       * DEDICATED WINDOW LOGIC:
       * Opens test in a new window and tries to close the original window immediately.
       */
      (function () {
        const windowName = "dedicatedAssessmentWindow";

        // Check if the window is already the dedicated one and not a temporary opener.
        if (window.name !== windowName && !window.opener) {
          const url = window.location.href;

          // Open a new, dedicated window.
          const newWindow = window.open(
            url,
            windowName,
            "width=" +
              screen.availWidth +
              ",height=" +
              screen.availHeight +
              ",resizable=yes,scrollbars=yes,location=no,menubar=no,toolbar=no,status=no"
          );

          if (newWindow) {
            // Try to close the original window immediately.
            // Note: window.close() often fails if the window was not opened by script.
            setTimeout(function () {
              window.close();
            }, 50);

            // Prevent further execution in the original tab (safer approach)
            document.body.style.display = "none";
            return;
          }
        }
      })();
          if (newWindow) {
            // Try to close the original window immediately.
            // Note: window.close() often fails if the window was not opened by script.
            setTimeout(function () {
              window.close();
            }, 50);

            // Prevent further execution in the original tab (safer approach)
            document.body.style.display = "none";
            return;
          }
        }
      })();
    </script>
    <script>
      /* This is the aggressive back button blocker using history.forward(). */

      function noBack() {
        window.history.forward();
      }
      /* This is the aggressive back button blocker using history.forward(). */

      function noBack() {
        window.history.forward();
      }

      window.history.forward();

      // **Global variable to track if a popstate (back/forward) event occurred.**
      let isNavigating = false;
      window.history.forward();

      // **Global variable to track if a popstate (back/forward) event occurred.**
      let isNavigating = false;

      document.addEventListener("DOMContentLoaded", function () {
        window.addEventListener("popstate", function (event) {
          // **WARNING:** Show a warning when back/forward is attempted
          alert(
            "‚ö†Ô∏è WARNING! Navigation Attempt Detected. The Back/Forward button is disabled for this assessment. Repeated attempts to navigate away may result in auto-submission."
          );
      document.addEventListener("DOMContentLoaded", function () {
        window.addEventListener("popstate", function (event) {
          // **WARNING:** Show a warning when back/forward is attempted
          alert(
            "‚ö†Ô∏è WARNING! Navigation Attempt Detected. The Back/Forward button is disabled for this assessment. Repeated attempts to navigate away may result in auto-submission."
          );

          // popstate ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ isNavigating ‡§ï‡•ã true ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§
          isNavigating = true;
          noBack(); // Prevent history navigation (as per your existing logic)

          // 500ms ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§´‡§º‡•ç‡§≤‡•à‡§ó ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§
          setTimeout(() => {
            isNavigating = false;
          }, 500);
        });
      });
    </script>


    <script>
      /* * Tab Change & Submission Lock Logic */

      let editorInstances = {}; // Defined here for global access
      let tabChangeCount = 0;
      const MAX_TAB_CHANGES = 3; // Allow 10 warnings before auto-submitting
      let submissionLocked = false;

      // ‡§Ø‡§π function ‡§Ö‡§¨ Tab Change Logic ‡§î‡§∞ Time Up Logic ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ú‡§ó‡§π ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§π‡•ã‡§ó‡§æ
      function lockAndAutoSubmit(reason) {
        if (submissionLocked) return;
        submissionLocked = true;

        // Polling interval ‡§ï‡•ã ‡§∞‡•ã‡§ï‡•á‡§Ç
        if (window.pollingInterval) clearInterval(window.pollingInterval);

        // Ensure title is reset/locked on submission
        document.title = "Assessment Submitted!"; // <-- Title locked
        // Ensure title is reset/locked on submission
        document.title = "Assessment Submitted!"; // <-- Title locked

        const form = document.getElementById("assessment-form");
        const submitButton = form.querySelector('button[type="submit"]');
        const form = document.getElementById("assessment-form");
        const submitButton = form.querySelector('button[type="submit"]');

        const message =
          reason === "time_up"
            ? "üö® Time is up! Your assessment is being automatically submitted by the server."
            : "üö® FINAL WARNING: You have exceeded the tab change limit. Your assessment is being automatically submitted.";
        const message =
          reason === "time_up"
            ? "üö® Time is up! Your assessment is being automatically submitted by the server."
            : "üö® FINAL WARNING: You have exceeded the tab change limit. Your assessment is being automatically submitted.";

        // 1. Disable and update the Submit button (UI feedback)
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "Auto-Submitting... üö´";
          submitButton.classList.remove("bg-green-600", "hover:bg-green-700");
          submitButton.classList.add("bg-red-800", "cursor-not-allowed");
        }

        // Update Timer Display for Time Up reason
        const timerElement = document.getElementById("timer");
        if (timerElement) {
          timerElement.textContent = "TIME UP";
          timerElement.classList.remove(
            "bg-red-600",
            "bg-yellow-500",
            "text-gray-800"
          );
          timerElement.classList.add("bg-red-800", "text-white");
        }
        // 1. Disable and update the Submit button (UI feedback)
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "Auto-Submitting... üö´";
          submitButton.classList.remove("bg-green-600", "hover:bg-green-700");
          submitButton.classList.add("bg-red-800", "cursor-not-allowed");
        }

        // Update Timer Display for Time Up reason
        const timerElement = document.getElementById("timer");
        if (timerElement) {
          timerElement.textContent = "TIME UP";
          timerElement.classList.remove(
            "bg-red-600",
            "bg-yellow-500",
            "text-gray-800"
          );
          timerElement.classList.add("bg-red-800", "text-white");
        }

        // 2. Final alert to the user before submission
        alert(message);
        // 2. Final alert to the user before submission
        alert(message);

        // 3. Force submission of the form
        // Save code editor content before submission
        document.querySelectorAll(".code-editor").forEach((editorContainer) => {
          const questionId = editorContainer.id.replace("editor-", "");
          const textarea = document.getElementById(`textarea-${questionId}`);
          const editor = editorInstances[questionId];
          if (editor) {
            textarea.value = editor.getValue();
          }
        });

        // Force the form submission
        form.submit();
      }
        // 3. Force submission of the form
        // Save code editor content before submission
        document.querySelectorAll(".code-editor").forEach((editorContainer) => {
          const questionId = editorContainer.id.replace("editor-", "");
          const textarea = document.getElementById(`textarea-${questionId}`);
          const editor = editorInstances[questionId];
          if (editor) {
            textarea.value = editor.getValue();
          }
        });

        // Force the form submission
        form.submit();
      }

      function handleVisibilityChange() {
        // Ignore if navigation is in progress or already submitted.
        if (window.isNavigating || submissionLocked) {
          return;
        }

        const originalTitle = "Assessment: {{ paper.title }}"; // Original Title
      function handleVisibilityChange() {
        // Ignore if navigation is in progress or already submitted.
        if (window.isNavigating || submissionLocked) {
          return;
        }

        const originalTitle = "Assessment: {{ paper.title }}"; // Original Title

        // Check if the document is hidden (user switched tabs or minimized)
        if (document.hidden) {
          // **üö® UI CHANGE: Update title on blur/hide**
          document.title = "Breakup";
        // Check if the document is hidden (user switched tabs or minimized)
        if (document.hidden) {
          // **üö® UI CHANGE: Update title on blur/hide**
          document.title = "Breakup";

          tabChangeCount++;

          if (tabChangeCount <= MAX_TAB_CHANGES) {
            // --- WARNING STATE ---
            alert(
              `‚ö†Ô∏è WARNING! Tab Switched. You have ${
                MAX_TAB_CHANGES - tabChangeCount
              } warnings remaining.`
            );
          } else {
            // --- LOCK & AUTO-SUBMIT STATE (Trigger auto-submit function) ---
            lockAndAutoSubmit("tab_switch");
          }
        } else {
          // **üö® UI CHANGE: Update title on focus/visible**
          document.title = "Patch Up"; // Temporarily show "Patch Up"
          setTimeout(() => {
            if (!submissionLocked) {
              document.title = originalTitle; // Revert to original title after a short delay
            }
          }, 1000);
        }
      }
          tabChangeCount++;

          if (tabChangeCount <= MAX_TAB_CHANGES) {
            // --- WARNING STATE ---
            alert(
              `‚ö†Ô∏è WARNING! Tab Switched. You have ${
                MAX_TAB_CHANGES - tabChangeCount
              } warnings remaining.`
            );
          } else {
            // --- LOCK & AUTO-SUBMIT STATE (Trigger auto-submit function) ---
            lockAndAutoSubmit("tab_switch");
          }
        } else {
          // **üö® UI CHANGE: Update title on focus/visible**
          document.title = "Patch Up"; // Temporarily show "Patch Up"
          setTimeout(() => {
            if (!submissionLocked) {
              document.title = originalTitle; // Revert to original title after a short delay
            }
          }, 1000);
        }
      }

      // Attach the event listener to the document
      document.addEventListener("visibilitychange", handleVisibilityChange);
      // Attach the event listener to the document
      document.addEventListener("visibilitychange", handleVisibilityChange);
    </script>

    <script>
      const OFFLINE_DIALOGUE_ID = "offline-dialogue";

      function showOfflineDialogue() {
        const dialogue = document.getElementById(OFFLINE_DIALOGUE_ID);
        if (dialogue) {
          dialogue.classList.remove("hidden");
        }
      }

      function hideOfflineDialogue() {
        const dialogue = document.getElementById(OFFLINE_DIALOGUE_ID);
        if (dialogue) {
          dialogue.classList.add("hidden");
        }
      }

      function checkConnectionAndHide() {
        if (navigator.onLine) {
          hideOfflineDialogue();
        } else {
          // If button is clicked and still offline, give an alert
          alert(
            "Still offline. Please check your network cables or Wi-Fi connection."
          );
        }
      }

      function handleOnlineStatus() {
        if (navigator.onLine) {
          hideOfflineDialogue();
          console.log("Internet connection restored.");
        } else {
          showOfflineDialogue();
          console.log("Internet connection lost!");
        }
      }

      // Add event listeners for online/offline status changes
      window.addEventListener("online", handleOnlineStatus);
      window.addEventListener("offline", handleOnlineStatus);

      // Initial check on load
      document.addEventListener("DOMContentLoaded", handleOnlineStatus);
    </script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "theme-primary": "#736b8e",
              "theme-dark": "#5f5778",
              "theme-light": "#e5e3e9",
              "gray-text": "#6B7280",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f7f9;
      }

      .question-card {
        transition: box-shadow 0.2s;
      }

      .question-card:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      }

      .answer-input {
        @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-primary;
      }

      .code-editor {
        min-height: 250px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
      }

      /* Reduced padding from 50px to 30px for compaction */
      #fixed-footer {
        z-index: 100;
        padding-bottom: 30px;
      }
    </style>
  </head>

  <body
    class="text-gray-800"
    onload="noBack()"
    onpageshow="if (event.persisted) noBack();"
  >
    <div
      id="start-overlay"
      class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 bg-opacity-90 z-50 text-center"
    >
      <h1 class="text-white text-3xl font-bold mb-4">
        Ready to Begin Your Test?
      </h1>
      <p class="text-gray-300 mb-6">
        Click below to start in fullscreen mode. Please do not close or minimize
        this window once started.
      </p>
      <button
        id="start-btn"
        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow-lg"
      >
        Start Test
      </button>
    </div>

    <script>
      document
        .getElementById("start-btn")
        .addEventListener("click", async function () {
          try {
            // Request fullscreen on current window
            const docEl = document.documentElement;
            if (docEl.requestFullscreen) {
              await docEl.requestFullscreen();
            } else if (docEl.webkitRequestFullscreen) {
              await docEl.webkitRequestFullscreen();
            }

            // Hide overlay after fullscreen starts
            document.getElementById("start-overlay").style.display = "none";

            // Optional: lock screen orientation (for mobile)
            if (screen.orientation && screen.orientation.lock) {
              screen.orientation.lock("landscape").catch(() => {});
            }
          } catch (err) {
            alert("Fullscreen failed: " + err.message);
          }
        });
    </script>

    <!-- ‚úÖ END OF ADDED BLOCK -->
    <div
      id="offline-dialogue"
      class="fixed inset-0 z-50 bg-gray-900 bg-opacity-80 flex items-center justify-center hidden"
      role="alert"
      aria-modal="true"
      aria-labelledby="dialog-title"
    >
      <div
        class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full transform transition-all duration-300 scale-100"
      >
        <div class="text-center">
          <i class="fas fa-wifi fa-3x text-red-600 mb-4"></i>
          <h3 id="dialog-title" class="text-2xl font-bold text-gray-900 mb-2">
            You Are Not Connected to the Internet
          </h3>
          <p id="dialog-message" class="text-gray-600 mb-6">
            Please restore your connection immediately. Assessment integrity
            requires a stable network.
          </p>
          <button
            onclick="checkConnectionAndHide()"
            class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none"
          >
            Check Connection Again
          </button>
        </div>
      </div>
    </div>
    <div class="min-h-screen">
      <header class="bg-white shadow-md sticky top-0 z-20">
        <div
          class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center"
        >
          <h1 class="text-xl font-bold text-theme-dark truncate">
            {{ paper.title }}
          </h1>

          <div class="flex items-center space-x-4">
            <span class="text-sm font-medium text-gray-600 hidden sm:inline">
              Duration: {{ paper.duration }} min
            </span>
            <div
              class="bg-red-600 text-white font-extrabold py-2 px-4 rounded-full shadow-lg text-lg sm:text-xl"
              id="timer"
            >
              Loading Time...
            </div>
          </div>
        </div>
      </header>

      <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        <form
          method="post"
          action="{% url 'test:user_test' link_id=link_id %}"
          class="space-y-8"
          id="assessment-form"
        >
          {% csrf_token %} {% for section in sections_list %}
          <div
            class="section-block p-5 bg-white rounded-xl shadow-lg border-t-4 border-theme-primary/70"
          >
            <h2 class="text-2xl font-bold text-theme-dark mb-5 border-b pb-2">
              {{ section.title }}
            </h2>

            <div class="space-y-5">
              {% for q in section.questions %}
              <div
                class="question-card p-3 border border-gray-200 rounded-lg bg-gray-50/50"
              >
                <p class="font-semibold text-lg mb-3">
                  Q{{ forloop.counter }}: {{ q.text }}
                  <span class="text-xs font-normal text-theme-primary"
                    >[{{ q.type }}]</span
                  >
                </p>

                {% if q.type == 'MCQ' %}
                <div class="space-y-2 mt-3">
                  {% for option in q.options %}
                  <label class="flex items-center text-gray-700">
                    <input
                      type="radio"
                      name="question_{{ q.id }}"
                      value="{{ option }}"
                      class="h-4 w-4 text-theme-dark border-gray-300 focus:ring-theme-dark"
                    />
                    <span class="ml-3 text-sm">{{ option }}</span>
                  </label>
                  {% endfor %}
                </div>

                {% elif q.type == 'CODE' %}
                <p class="text-sm text-gray-600 mb-2 mt-3">
                  Write, run and submit your code below:
                </p>

                <div
                  class="mt-3 border border-gray-300 rounded-lg overflow-hidden"
                >
                  <iframe
                    id="oc-editor-{{ q.id }}"
                    frameborder="0"
                    height="450px"
                    width="100%"
                    src="https://onecompiler.com/embed/"
                  ></iframe>
                </div>

                <textarea
                  name="question_{{ q.id }}"
                  id="textarea-{{ q.id }}"
                  class="hidden"
                ></textarea>

                <div class="mt-3 flex space-x-3">
                  <button
                    type="button"
                    onclick="submitCode({{ q.id }})"
                    class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm"
                  >
                    <i class="fas fa-check mr-1"></i> Submit Code
                  </button>
                </div>

                {% else %}
                <textarea
                  name="question_{{ q.id }}"
                  rows="6"
                  placeholder="Type your detailed answer here..."
                  class="answer-input resize-y mt-3"
                ></textarea>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}

          <div class="h-16 sm:h-20"></div>
        </form>
      </main>

      <div
        id="fixed-footer"
        class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl z-20"
      >
        <div class="max-w-5xl mx-auto flex justify-end">
          <button
            type="submit"
            form="assessment-form"
            class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg text-lg hover:bg-green-700 transition-colors shadow-lg focus:outline-none"
          >
            Submit Final Assessment
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- NEW BACKEND-CONTROLLED TIMER LOGIC VARIABLES ---
      let totalSeconds = -1; // Server ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§ï‡•Å‡§≤ ‡§∂‡•á‡§∑ ‡§∏‡§Æ‡§Ø
      const POLLING_RATE_SECONDS = 15; // ‡§π‡§∞ 15 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§∏‡§Æ‡§Ø ‡§∏‡§ø‡§Ç‡§ï ‡§ï‡§∞‡•á‡§Ç
      // pollingInterval ‡§î‡§∞ submissionLocked globals ‡§Ö‡§¨ window scope ‡§Æ‡•á‡§Ç ‡§π‡•à‡§Ç‡•§
      window.pollingInterval = null;

      // --- TIMER DISPLAY HELPER FUNCTIONS ---
      function formatTime(seconds) {
        if (seconds < 0) seconds = 0;
        let minutes = parseInt(seconds / 60, 10);
        let secs = parseInt(seconds % 60, 10);

        minutes = minutes < 10 ? "0" + minutes : minutes;
        secs = secs < 10 ? "0" + secs : secs;

        return minutes + ":" + secs;
      }

      function updateTimerDisplay(seconds) {
        let timerElement = document.getElementById("timer");
        if (!timerElement) return;

        timerElement.textContent = formatTime(seconds);

        // Update color based on remaining time
        timerElement.classList.remove(
          "bg-yellow-500",
          "text-gray-800",
          "bg-red-700",
          "bg-red-800",
          "text-white",
          "bg-red-600"
        );

        if (seconds <= 60) {
          timerElement.classList.add("bg-red-700", "text-white");
        } else if (seconds <= 300) {
          // 5 minutes
          timerElement.classList.add("bg-yellow-500", "text-gray-800");
        } else {
          timerElement.classList.add("bg-red-600", "text-white");
        }
      }

      // --- POLLING LOGIC ---
      function pollTimeRemaining(linkId, formId) {
        // Django's URL template tag ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
        const timeUrl =
          "{% url 'test:get_time_remaining_api' link_id=link_id %}";
        let timerElement = document.getElementById("timer");

        // ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§∏‡§Æ‡§Ø ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è API ‡§ï‡•â‡§≤
        fetch(timeUrl, {
          method: "GET",
          method: "GET",
        })
          .then((response) => {
          .then((response) => {
            if (!response.ok) {
              throw new Error("Server Time API response not ok");
              throw new Error("Server Time API response not ok");
            }
            return response.json();
          })
          .then((data) => {
          })
          .then((data) => {
            if (data.error) {
              console.error("Server Time Error:", data.error);
              if (window.pollingInterval) clearInterval(window.pollingInterval);
              if (timerElement) timerElement.textContent = "Error";
              return;
              console.error("Server Time Error:", data.error);
              if (window.pollingInterval) clearInterval(window.pollingInterval);
              if (timerElement) timerElement.textContent = "Error";
              return;
            }

            // ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§∏‡§ü‡•Ä‡§ï ‡§∏‡§Æ‡§Ø ‡§ï‡•ã ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            totalSeconds = data.remaining_seconds;

            if (data.time_up || totalSeconds <= 0) {
              // ‡§Ö‡§ó‡§∞ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§®‡•á 'time_up' ‡§≠‡•á‡§ú ‡§¶‡§ø‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã ‡§™‡•ã‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç
              if (window.pollingInterval) clearInterval(window.pollingInterval);
              lockAndAutoSubmit("time_up");
            } else {
              updateTimerDisplay(totalSeconds);
            }
          })
          .catch((error) => {
            console.error("Fetch Error:", error);
            if (timerElement) timerElement.textContent = "Sync Error";
          });
      }

      // --- SKULPT PYTHON EXECUTION LOGIC (Remains Unchanged) ---
      function outf(text, questionId) {
        const outputElement = document.getElementById(`output-${questionId}`);
        outputElement.textContent += text;
        outputElement.classList.remove("hidden", "bg-red-900", "text-red-300");
        outputElement.classList.add("bg-gray-800", "text-green-300");
      }

      function builtinRead(x) {
        if (
          Sk.builtinFiles === undefined ||
          Sk.builtinFiles["files"][x] === undefined
        )
          throw "File not found: '" + x + "'";
        return Sk.builtinFiles["files"][x];
      }

      function runCode(questionId) {
        const editor = editorInstances[questionId];
        const code = editor.getValue();
        const outputElement = document.getElementById(`output-${questionId}`);
        const runButton = document.getElementById(`run-btn-${questionId}`);

        outputElement.textContent = "Running...";
        outputElement.classList.remove(
          "hidden",
          "bg-red-900",
          "text-green-300"
        );
        outputElement.classList.add("bg-gray-700", "text-white");
        runButton.disabled = true;
        runButton.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-1"></i> Running...';

        Sk.pre = "output-" + questionId;

        Sk.configure({
          output: (text) => outf(text, questionId),
          read: builtinRead,
          execLimit: 5000,
        });

        Sk.misceval
          .asyncToPromise(function () {
            return Sk.importMainWithBody("<stdin>", false, code, true);
          })
          .then(
            function (mod) {
              runButton.innerHTML =
                '<i class="fas fa-play mr-1"></i> Run Code (Browser)';
            },
            function (err) {
              outputElement.textContent = "Error:\n" + err.toString();
              outputElement.classList.remove("bg-gray-700", "text-white");
              outputElement.classList.add("bg-red-900", "text-red-300");
              runButton.innerHTML =
                '<i class="fas fa-play mr-1"></i> Run Code (Browser)';
            }
          )
          .finally(() => {
            runButton.disabled = false;
          });
      }

      // --- MONACO EDITOR & INIT LOGIC ---
      document.addEventListener("DOMContentLoaded", function () {
        // --- START TIMER INIT: POLLING & LOCAL TICKER ---
        const linkIdFromDjango = "{{ link_id }}";
        const formId = "assessment-form";

        // 1. Local Ticker: ‡§π‡§∞ 1 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç UI ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        setInterval(() => {
          if (totalSeconds > 0 && !submissionLocked) {
            totalSeconds--;
            updateTimerDisplay(totalSeconds);
          }
          // ‡§Ö‡§ó‡§∞ 0 ‡§™‡§∞ ‡§™‡§π‡•Å‡§Ç‡§ö ‡§ó‡§Ø‡§æ ‡§§‡•ã auto-submit logic ‡§ö‡§≤‡§æ‡§ì (safety ‡§ï‡•á ‡§≤‡§ø‡§è)
          if (totalSeconds <= 0 && !submissionLocked) {
            if (window.pollingInterval) clearInterval(window.pollingInterval);
            lockAndAutoSubmit("time_up");
          }
        }, 1000);

        // 2. Server Polling: ‡§π‡§∞ 15 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§∏‡§ü‡•Ä‡§ï ‡§∏‡§Æ‡§Ø ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
        window.pollingInterval = setInterval(() => {
          // Only poll if not already locked
          if (!submissionLocked) {
            pollTimeRemaining(linkIdFromDjango, formId);
          } else {
            clearInterval(window.pollingInterval);
          }
        }, POLLING_RATE_SECONDS * 1000);

        // 3. ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§™‡§∞ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç (Initial Time ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è)
        pollTimeRemaining(linkIdFromDjango, formId);

        // Monaco Editor Initialization
        require.config({
          paths: {
            vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs",
          },
        });
        require(["vs/editor/editor.main"], function () {
          document
            .querySelectorAll(".code-editor")
            .forEach((editorContainer) => {
              const questionId = editorContainer.id.replace("editor-", "");
              const textarea = document.getElementById(
                `textarea-${questionId}`
              );

              if (editorContainer.hasAttribute("data-monaco-initialized"))
                return;
              editorContainer.setAttribute("data-monaco-initialized", "true");

              const editor = monaco.editor.create(editorContainer, {
                value: textarea.value || "",
                language: "python",
                theme: "vs-light",
                minimap: { enabled: false },
                automaticLayout: true,
                tabSize: 4,
              });

              editorInstances[questionId] = editor;

              // Update hidden textarea when editor content changes
              editor.onDidChangeModelContent(() => {
                textarea.value = editor.getValue();
              });
            });
        });

        // Final submission handler (Saves all code before submission)
        document
          .getElementById("assessment-form")
          .addEventListener("submit", function () {
            if (window.pollingInterval) clearInterval(window.pollingInterval); // Stop polling on manual submit

            document
              .querySelectorAll(".code-editor")
              .forEach((editorContainer) => {
                const questionId = editorContainer.id.replace("editor-", "");
                const textarea = document.getElementById(
                  `textarea-${questionId}`
                );
                const editor = editorInstances[questionId];

                if (editor) {
                  textarea.value = editor.getValue();
                }
              });
          });
      });
    </script>
  </body>
</html>
