{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment: {{ paper.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/2.0.0/skulpt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/2.0.0/skulpt-stdlib.min.js"></script>

    <script>
        /* This is the new aggressive back button blocker using history.forward(). */
        
        // Step 1: Set up a reusable function to force forward movement
        function noBack() {
            window.history.forward();
        }

        // Step 2: Use window.history.forward() immediately on load
        window.history.forward(); 
        
        // Step 3: Add event listeners on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // This ensures the noBack function is used when the browser detects a back movement
            window.addEventListener('popstate', noBack);
        });
        
    </script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "theme-primary": "#736b8e",
              "theme-dark": "#5f5778",
              "theme-light": "#e5e3e9",
              "gray-text": "#6B7280",
            },
          },
        },
      };
    </script>
    <style>
        body { font-family: "Inter", sans-serif; background-color: #f4f7f9; }
        .question-card { transition: box-shadow 0.2s; }
        .question-card:hover { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); }
        .answer-input { @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-theme-primary; }
        .code-editor { min-height: 250px; border: 1px solid #e5e7eb; border-radius: 6px; }
        /* Reduced padding from 50px to 30px for compaction */
        #fixed-footer { z-index: 100; padding-bottom: 30px; } 
    </style>
</head>
<body class="text-gray-800" onload="noBack()" onpageshow="if (event.persisted) noBack();">

<div class="min-h-screen">
    <header class="bg-white shadow-md sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-theme-dark truncate">
                {{ paper.title }}
            </h1>
            
            <div class="flex items-center space-x-4">
                <span class="text-sm font-medium text-gray-600 hidden sm:inline">
                    Duration: {{ paper.duration }} min
                </span>
                <div class="bg-red-600 text-white font-extrabold py-2 px-4 rounded-full shadow-lg text-lg sm:text-xl" id="timer">
                    </div>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        <form method="post" action="{% url 'test:user_test' link_id=link_id %}" class="space-y-8" id="assessment-form">
            {% csrf_token %}

            {% for section in sections_list %}
                <div class="section-block p-5 bg-white rounded-xl shadow-lg border-t-4 border-theme-primary/70">
                    <h2 class="text-2xl font-bold text-theme-dark mb-5 border-b pb-2">
                        {{ section.title }}
                    </h2>

                    <div class="space-y-5">
                        {% for q in section.questions %}
                            <div class="question-card p-3 border border-gray-200 rounded-lg bg-gray-50/50">
                                <p class="font-semibold text-lg mb-3">
                                    Q{{ forloop.parentloop.counter }}.{{ forloop.counter }}: {{ q.text }}
                                    <span class="text-xs font-normal text-theme-primary">[{{ q.type }}]</span>
                                </p>
                                
                                {% if q.type == 'MCQ' %}
                                    <div class="space-y-2 mt-3">
                                        {% for option in q.options %}
                                            <label class="flex items-center text-gray-700">
                                                <input type="radio" 
                                                       name="question_{{ q.id }}" 
                                                       value="{{ option }}" 
                                                       class="h-4 w-4 text-theme-dark border-gray-300 focus:ring-theme-dark">
                                                <span class="ml-3 text-sm">{{ option }}</span>
                                            </label>
                                        {% endfor %}
                                    </div>

                                {% elif q.type == 'CODE' %}
                                    <p class="text-sm text-gray-600 mb-2 mt-3">Write your code below (Python):</p>
                                    <div id="editor-{{ q.id }}" class="code-editor mt-2"></div>
                                    
                                    <textarea name="question_{{ q.id }}" id="textarea-{{ q.id }}" class="hidden"></textarea>

                                    <div class="mt-3 flex space-x-3">
                                        <button type="button" 
                                                onclick="runCode({{ q.id }})"
                                                id="run-btn-{{ q.id }}"
                                                class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                            <i class="fas fa-play mr-1"></i> Run Code (Browser)
                                        </button>
                                    </div>

                                    <div id="output-{{ q.id }}" 
                                         class="mt-3 p-3 text-xs bg-gray-800 text-green-300 rounded-lg whitespace-pre-wrap hidden">
                                        
                                    </div>

                                {% else %}
                                    <textarea 
                                        name="question_{{ q.id }}" 
                                        rows="6" 
                                        placeholder="Type your detailed answer here..."
                                        class="answer-input resize-y mt-3"
                                    ></textarea>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
            
            <div class="h-16 sm:h-20"></div> 
        </form>
    </main>

    <div id="fixed-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl z-20">
        <div class="max-w-5xl mx-auto flex justify-end">
            <button 
                type="submit" 
                form="assessment-form"
                class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg text-lg 
                       hover:bg-green-700 transition-colors shadow-lg focus:outline-none"
            >
                Submit Final Assessment
            </button>
        </div>
    </div>
</div>

<script>
    let editorInstances = {}; // Store editor instances globally
    
    // --- TIMER AND AUTO-SUBMIT LOGIC ---
    function startTimer(durationInMinutes, formId) {
        let timerElement = document.getElementById('timer');
        let form = document.getElementById(formId);
        
        if (!timerElement || !form) return;

        let totalSeconds = durationInMinutes * 60;

        const interval = setInterval(() => {
            let minutes = parseInt(totalSeconds / 60, 10);
            let seconds = parseInt(totalSeconds % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            timerElement.textContent = minutes + ":" + seconds;

            // Optional: Change color when less than 5 minutes remain
            if (totalSeconds <= 300) {
                 timerElement.classList.add('bg-yellow-500', 'text-gray-800');
            }
            // Optional: Change color when less than 1 minute remains
            if (totalSeconds <= 60) {
                 timerElement.classList.remove('bg-yellow-500', 'text-gray-800');
                 timerElement.classList.add('bg-red-700', 'text-white');
            }


            if (--totalSeconds < 0) {
                clearInterval(interval);
                timerElement.textContent = "TIME UP";
                
                // 1. Final Save: Update all hidden textareas before submission
                document.querySelectorAll('.code-editor').forEach(editorContainer => {
                    const questionId = editorContainer.id.replace('editor-', '');
                    const textarea = document.getElementById(`textarea-${questionId}`);
                    const editor = editorInstances[questionId];
                    if (editor) {
                        textarea.value = editor.getValue();
                    }
                });

                // 2. AUTO-SUBMIT THE FORM
                form.submit();
            }
        }, 1000);
    }
    
    // --- SKULPT PYTHON EXECUTION LOGIC ---
    function outf(text, questionId) {
        const outputElement = document.getElementById(`output-${questionId}`);
        outputElement.textContent += text;
        outputElement.classList.remove('hidden', 'bg-red-900', 'text-red-300');
        outputElement.classList.add('bg-gray-800', 'text-green-300');
    }
    
    function builtinRead(x) {
        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
            throw "File not found: '" + x + "'";
        return Sk.builtinFiles["files"][x];
    }
    
    function runCode(questionId) {
        const editor = editorInstances[questionId];
        const code = editor.getValue();
        const outputElement = document.getElementById(`output-${questionId}`);
        const runButton = document.getElementById(`run-btn-${questionId}`);

        outputElement.textContent = "Running...";
        outputElement.classList.remove('hidden', 'bg-red-900', 'text-green-300');
        outputElement.classList.add('bg-gray-700', 'text-white');
        runButton.disabled = true;
        runButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Running...';

        Sk.pre = "output-" + questionId;
        
        Sk.configure({
            output: (text) => outf(text, questionId),
            read: builtinRead,
            // Configure max execution time (e.g., 5 seconds) to prevent infinite loops from freezing the browser
            execLimit: 5000 
        });
        
        // Asynchronously run the code
        (Sk.misceval.asyncToPromise(function() {
            return Sk.importMainWithBody("<stdin>", false, code, true);
        })).then(function(mod) {
            // Success
            runButton.innerHTML = '<i class="fas fa-play mr-1"></i> Run Code (Browser)';
        }, function(err) {
            // Error
            outputElement.textContent = "Error:\n" + err.toString();
            outputElement.classList.remove('bg-gray-700', 'text-white');
            outputElement.classList.add('bg-red-900', 'text-red-300');
            runButton.innerHTML = '<i class="fas fa-play mr-1"></i> Run Code (Browser)';
        }).finally(() => {
            runButton.disabled = false;
        });
    }


    // --- MONACO EDITOR & INIT LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- START TIMER INIT ---
        const durationFromDjango = {{ paper.duration|default:"60" }}; 
        
        if (durationFromDjango > 0) {
            startTimer(durationFromDjango, 'assessment-form');
        } else {
            // Hide timer if duration is invalid/zero
            document.getElementById('timer').style.display = 'none';
        }


        // Monaco Editor Initialization
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            document.querySelectorAll('.code-editor').forEach(editorContainer => {
                const questionId = editorContainer.id.replace('editor-', '');
                const textarea = document.getElementById(`textarea-${questionId}`);

                if (editorContainer.hasAttribute('data-monaco-initialized')) return;
                editorContainer.setAttribute('data-monaco-initialized', 'true');

                const editor = monaco.editor.create(editorContainer, {
                    value: textarea.value || '',
                    language: 'python', 
                    theme: 'vs-light',
                    minimap: { enabled: false },
                    automaticLayout: true,
                    tabSize: 4,
                });
                
                editorInstances[questionId] = editor; 

                // Update hidden textarea when editor content changes
                editor.onDidChangeModelContent(() => {
                    textarea.value = editor.getValue();
                });
            });
        });
        
        // Final submission handler (Saves all code before submission)
        document.getElementById('assessment-form').addEventListener('submit', function() {
            document.querySelectorAll('.code-editor').forEach(editorContainer => {
                 const questionId = editorContainer.id.replace('editor-', '');
                 const textarea = document.getElementById(`textarea-${questionId}`);
                 const editor = editorInstances[questionId];
                 
                 if (editor) {
                     textarea.value = editor.getValue();
                 }
            });
        });
    });
</script>

</body>
</html>