<!-- <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Powered Assessment Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Custom styles for hiding number input spinner buttons */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      /* Helper classes for JS-driven step transitions */
      .step-transition {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }
      .step-hidden {
        opacity: 0;
        transform: translateY(10px);
        position: absolute;
        pointer-events: none;
        z-index: -10;
      }
      .step-active {
        opacity: 1;
        transform: translateY(0);
        position: static;
        pointer-events: auto;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800 flex min-h-screen font-sans">
    {% include 'partials/sidebar.html' %}
    <div class="flex-1 flex flex-col overflow-hidden">
      <header
        class="bg-white shadow-sm h-16 flex items-center justify-between px-6"
      >
        <h1 class="text-xl font-semibold text-slate-800"></h1>

        <div class="relative">
          <button
            id="user-menu-button"
            class="flex items-center space-x-2 focus:outline-none"
          >
            <img
              class="h-9 w-9 rounded-full object-cover"
              src="https://ui-avatars.com/api/?name={{ user.first_name }}+{{ user.last_name }}&background=e2e8f0&color=64748b"
              alt="User avatar"
            />
            <span class="hidden md:block font-medium"
              >{{ user.first_name }} {{ user.last_name }}</span
            >
            <svg
              class="hidden md:block w-4 h-4 text-slate-500"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19.5 8.25l-7.5 7.5-7.5-7.5"
              />
            </svg>
          </button>
          <div
            id="user-menu"
            class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border z-10"
          >
            <div class="px-4 py-3 border-b">
              <p class="font-semibold">
                {{ user.first_name }} {{ user.last_name }}
              </p>
              <p class="text-sm text-slate-500 truncate">{{ user.email }}</p>
            </div>
            <div class="py-1">
              {% if user.profile %}
              <div class="px-4 py-2 text-sm text-slate-700">
                Phone: {{ user.profile.phone_number }}
              </div>
              {% endif %}
              <a
                href="#"
                class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"
                >Profile</a
              >
              <a
                href="#"
                class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"
                >Settings</a
              >
            </div>
            <div class="py-1 border-t">
              <a
                href="{% url 'logout' %}"
                class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-slate-100"
                >Logout</a
              >
            </div>
          </div>
        </div>
      </header>

      <main class="flex-1 p-6 md:p-10">
        <div id="form-container" class="max-w-4xl mx-auto relative">
          <div id="step-1" class="step-transition step-active">
            <h1 class="text-3xl font-bold mb-8 text-slate-800">
              Create Question Paper
            </h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <label
                  for="jobTitle"
                  class="block text-sm font-medium text-slate-700 mb-1"
                  >Job Title <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="jobTitle"
                  placeholder="Enter Job Title"
                  class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[#736b8e] focus:border-transparent transition"
                />
              </div>
              <div>
                <label
                  for="department"
                  class="block text-sm font-medium text-slate-700 mb-1"
                  >Department <span class="text-red-500">*</span></label
                >

                <select
                  id="department"
                  class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#736b8e] focus:border-transparent transition"
                >
                  <option value="" disabled selected>Select Department</option>

                  {% for dept in departments %}
                  <option value="{{ dept.name }}">{{ dept.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label
                  for="skills"
                  class="block text-sm font-medium text-slate-700 mb-1"
                  >Required Skills <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="skills"
                  placeholder="e.g., React, Nodejs, SQL"
                  class="w-full px-4 py-3 bg-white border border-slate-300 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[#736b8e] focus:border-transparent transition"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1"
                  >Experience (Years) <span class="text-red-500">*</span></label
                >
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1"
                      >Min</label
                    >
                    <div
                      class="flex items-center border border-slate-300 rounded-lg bg-white"
                    >
                      <button
                        onclick="updateCount(this, -1)"
                        class="px-3 py-2 text-slate-600 hover:bg-slate-100 rounded-l-lg"
                      >
                        -
                      </button>
                      <input
                        type="number"
                        id="minExp"
                        value="0"
                        class="w-full text-center border-l border-r py-2 focus:outline-none bg-transparent placeholder-slate-400"
                      />
                      <button
                        onclick="updateCount(this, 1)"
                        class="px-3 py-2 text-slate-600 hover:bg-slate-100 rounded-r-lg"
                      >
                        +
                      </button>
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1"
                      >Max</label
                    >
                    <div
                      class="flex items-center border border-slate-300 rounded-lg bg-white"
                    >
                      <button
                        onclick="updateCount(this, -1)"
                        class="px-3 py-2 text-slate-600 hover:bg-slate-100 rounded-l-lg"
                      >
                        -
                      </button>
                      <input
                        type="number"
                        id="maxExp"
                        value="1"
                        class="w-full text-center border-l border-r py-2 focus:outline-none bg-transparent placeholder-slate-400"
                      />
                      <button
                        onclick="updateCount(this, 1)"
                        class="px-3 py-2 text-slate-600 hover:bg-slate-100 rounded-r-lg"
                      >
                        +
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-12 flex justify-start">
              <button
                onclick="nextStep()"
                class="w-full sm:w-auto bg-[#736b8e] text-white font-semibold px-8 py-3 rounded-lg hover:bg-[#5f5778] transition-colors shadow-md hover:shadow-lg"
              >
                Next
              </button>
            </div>
          </div>

          <div id="step-2" class="step-transition step-hidden">
            <h1 class="text-3xl font-bold mb-8 text-slate-800">
              Configure Assessment
            </h1>
            <div
              class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-slate-200"
            >
              <h3 class="text-lg font-semibold text-slate-800">
                Number of Questions
              </h3>
              <p class="text-sm text-slate-500 mt-1 mb-6">
                Set the question count for each section of the test.
              </p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div
                  data-section="Coding"
                  class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between"
                >
                  <label class="font-medium text-slate-700"
                    >Coding <span class="text-red-500">*</span></label
                  >
                  <div
                    class="flex items-center border border-slate-300 rounded-lg bg-white w-fit mt-2 sm:mt-0"
                  >
                    <button
                      onclick="updateCount(this, -1)"
                      class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-l-lg transition-colors"
                    >
                      -
                    </button>
                    <input
                      type="number"
                      value="1"
                      class="w-16 text-center font-semibold text-lg text-[#736b8e] border-l border-r py-1.5 focus:outline-none bg-transparent"
                    />
                    <button
                      onclick="updateCount(this, 1)"
                      class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-r-lg transition-colors"
                    >
                      +
                    </button>
                  </div>
                </div>
                <div
                  data-section="Aptitude"
                  class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between"
                >
                  <label class="font-medium text-slate-700"
                    >Aptitude <span class="text-red-500">*</span></label
                  >
                  <div
                    class="flex items-center border border-slate-300 rounded-lg bg-white w-fit mt-2 sm:mt-0"
                  >
                    <button
                      onclick="updateCount(this, -1)"
                      class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-l-lg transition-colors"
                    >
                      -
                    </button>
                    <input
                      type="number"
                      value="1"
                      class="w-16 text-center font-semibold text-lg text-[#736b8e] border-l border-r py-1.5 focus:outline-none bg-transparent"
                    />
                    <button
                      onclick="updateCount(this, 1)"
                      class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-r-lg transition-colors"
                    >
                      +
                    </button>
                  </div>
                </div>
                <div
                  data-section="Quant"
                  class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between"
                >
                  <label class="font-medium text-slate-700"
                    >Quant <span class="text-red-500">*</span></label
                  >
                  <div
                    class="flex items-center border border-slate-300 rounded-lg bg-white w-fit mt-2 sm:mt-0"
                  >
                    <button
                      onclick="updateCount(this, -1)"
                      class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-l-lg transition-colors"
                    >
                      -
                    </button>
                    <input
                      type="number"
                      value="1"
                      class="w-16 text-center font-semibold text-lg text-[#736b8e] border-l border-r py-1.5 focus:outline-none bg-transparent"
                    />
                    <button
                      onclick="updateCount(this, 1)"
                      class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-r-lg transition-colors"
                    >
                      +
                    </button>
                  </div>
                </div>
                <div
                  data-section="DSA"
                  class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between"
                >
                  <label class="font-medium text-slate-700"
                    >DSA <span class="text-red-500">*</span></label
                  >
                  <div
                    class="flex items-center border border-slate-300 rounded-lg bg-white w-fit mt-2 sm:mt-0"
                  >
                    <button
                      onclick="updateCount(this, -1)"
                      class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-l-lg transition-colors"
                    >
                      -
                    </button>
                    <input
                      type="number"
                      value="1"
                      class="w-16 text-center font-semibold text-lg text-[#736b8e] border-l border-r py-1.5 focus:outline-none bg-transparent"
                    />
                    <button
                      onclick="updateCount(this, 1)"
                      class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-r-lg transition-colors"
                    >
                      +
                    </button>
                  </div>
                </div>
              </div>

              <div class="mt-8 border-t border-slate-200 pt-6">
                <label
                  for="duration"
                  class="block text-sm font-medium text-slate-700 mb-1"
                  >Test Duration (in minutes)
                  <span class="text-red-500">*</span></label
                >
                <div class="relative mt-1">
                  <div
                    class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5 text-slate-400"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                  </div>
                  <input
                    type="number"
                    id="duration"
                    placeholder="e.g., 60"
                    class="w-full md:w-1/2 pl-10 pr-4 py-3 bg-white border border-slate-300 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-[#736b8e] focus:border-transparent transition"
                  />
                </div>
              </div>
            </div>

            <div class="mt-12 flex flex-col sm:flex-row w-full gap-4">
              <button
                onclick="prevStep()"
                class="w-full sm:w-auto bg-slate-200 text-slate-800 font-semibold px-8 py-3 rounded-lg hover:bg-slate-300 transition-colors"
              >
                Back
              </button>
              <button
                onclick="nextStep()"
                class="w-full sm:w-auto bg-[#736b8e] text-white font-semibold px-8 py-3 rounded-lg hover:bg-[#5f5778] transition-colors shadow-md hover:shadow-lg"
              >
                Next
              </button>
            </div>
          </div>

          <div id="step-3" class="step-transition step-hidden">
            <h1 class="text-3xl font-bold mb-8 text-slate-800">
              Review & Generate
            </h1>
            <div
              class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-slate-200"
            >
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8">
                <div class="space-y-6">
                  <div>
                    <h3 class="text-lg font-semibold text-slate-800">
                      Role Details
                    </h3>
                    <p class="text-sm text-slate-500">
                      Confirm the details for the position.
                    </p>
                  </div>
                  <div class="space-y-4">
                    <div
                      class="flex justify-between items-baseline pb-2 border-b border-slate-100"
                    >
                      <p class="text-sm font-medium text-slate-500">
                        Job Title
                      </p>
                      <p
                        id="review-jobTitle"
                        class="font-semibold text-slate-800 text-base text-right"
                      ></p>
                    </div>
                    <div
                      class="flex justify-between items-baseline pb-2 border-b border-slate-100"
                    >
                      <p class="text-sm font-medium text-slate-500">
                        Department
                      </p>
                      <p
                        id="review-department"
                        class="font-semibold text-slate-800 text-base text-right"
                      ></p>
                    </div>
                    <div
                      class="flex justify-between items-baseline pb-2 border-b border-slate-100"
                    >
                      <p class="text-sm font-medium text-slate-500">
                        Experience
                      </p>
                      <p
                        id="review-experience"
                        class="font-semibold text-slate-800 text-base text-right"
                      ></p>
                    </div>
                    <div class="flex items-start">
                      <p
                        class="w-32 flex-shrink-0 text-sm font-medium text-slate-500"
                      >
                        Required Skills
                      </p>
                      <div
                        id="review-skills"
                        class="flex flex-1 flex-wrap gap-2 justify-end"
                      ></div>
                    </div>
                  </div>
                </div>

                <div class="space-y-6 lg:border-l lg:pl-12 border-slate-200">
                  <div>
                    <h3 class="text-lg font-semibold text-slate-800">
                      Assessment Structure
                    </h3>
                    <p class="text-sm text-slate-500">
                      A summary of the test format.
                    </p>
                  </div>
                  <div
                    class="bg-slate-50 p-4 rounded-lg border border-slate-200"
                  >
                    <p class="text-sm font-medium text-slate-500">
                      Test Duration
                    </p>
                    <p
                      id="review-duration"
                      class="font-semibold text-slate-800 text-lg"
                    ></p>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-slate-500 mb-2">
                      Sections
                    </p>
                    <div
                      id="review-sections"
                      class="space-y-2 border rounded-lg p-4"
                    ></div>
                  </div>
                  <div
                    class="bg-[#736b8e] text-white p-4 rounded-lg flex justify-between items-center"
                  >
                    <span class="font-semibold">Total Questions</span>
                    <span
                      id="review-total"
                      class="text-xl font-bold bg-white text-[#736b8e] px-3 py-1 rounded-full"
                    ></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-12 flex flex-col sm:flex-row w-full gap-4">
              <button
                onclick="prevStep()"
                class="w-full sm:w-auto bg-slate-200 text-slate-800 font-semibold px-8 py-3 rounded-lg hover:bg-slate-300 transition-colors"
              >
                Back
              </button>
              <button
                onclick="generatePaper()"
                class="w-full sm:w-auto bg-[#736b8e] text-white font-semibold px-8 py-3 rounded-lg hover:bg-[#5f5778] transition-colors shadow-md hover:shadow-lg flex items-center justify-center"
              >
                Generate
              </button>
            </div>
          </div>
        </div>

        <div id="paper-container" class="max-w-4xl mx-auto hidden">
          <div
            class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8"
          >
            <h1
              id="paper-header"
              class="text-2xl sm:text-3xl font-bold text-slate-800"
            ></h1>
            <div class="flex gap-2">
              <button
                onclick="savePaper()"
                class="flex-1 sm:flex-none bg-[#736b8e] text-white font-semibold px-6 py-2 rounded-lg hover:bg-[#5f5778] transition-colors shadow-md hover:shadow-lg"
              >
                Save
              </button>
              <button
                onclick="alert('Editing is not implemented in this demo.')"
                class="flex-1 sm:flex-none bg-slate-200 text-slate-800 font-semibold px-6 py-2 rounded-lg hover:bg-slate-300 transition-colors"
              >
                Edit
              </button>
            </div>
          </div>
          <div
            class="space-y-6 bg-white p-6 sm:p-8 rounded-lg shadow-sm border border-slate-200 mb-8"
          >
            <div class="flex flex-col sm:flex-row">
              <span
                class="w-full sm:w-32 font-semibold text-slate-600 mb-1 sm:mb-0"
                >Job Title:</span
              >
              <span id="paper-jobTitle" class="text-slate-800"></span>
            </div>
            <div class="flex flex-col sm:flex-row">
              <span
                class="w-full sm:w-32 font-semibold text-slate-600 mb-1 sm:mb-0"
                >Department:</span
              >
              <span id="paper-department" class="text-slate-800"></span>
            </div>
            <div class="flex flex-col sm:flex-row">
              <span
                class="w-full sm:w-32 font-semibold text-slate-600 mb-1 sm:mb-0"
                >Duration:</span
              >
              <span id="paper-duration" class="text-slate-800"></span>
            </div>
            <div class="flex flex-col sm:flex-row">
              <span
                class="w-full sm:w-32 font-semibold text-slate-600 mb-1 sm:mb-0"
                >Experience:</span
              >
              <span id="paper-experience" class="text-slate-800"></span>
            </div>
            <div class="flex flex-col sm:flex-row">
              <span
                class="w-full sm:w-32 font-semibold text-slate-600 mt-1 mb-1 sm:mb-0"
                >Skills:</span
              >
              <div id="paper-skills" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
          <div>
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Questions:</h2>
            <div class="space-y-8" id="paper-questions"></div>
          </div>
        </div>
      </main>
    </div>
    <script>
      // --- UI HELPER SCRIPTS (SIDEBAR, USER MENU) ---
      document.addEventListener("DOMContentLoaded", function () {
        const sidebar = document.getElementById("sidebar");
        const toggleButton = document.getElementById("sidebar-toggle");
        const sidebarLogo = document.getElementById("sidebar-logo");
        const sidebarTexts = document.querySelectorAll(".sidebar-text");
        const sidebarHeader = document.getElementById("sidebar-header");

        if (toggleButton) {
          toggleButton.addEventListener("click", () => {
            sidebar.classList.toggle("w-64");
            sidebar.classList.toggle("w-20");
            sidebarLogo.classList.toggle("hidden");
            sidebarHeader.classList.toggle("justify-between");
            sidebarHeader.classList.toggle("justify-center");
            sidebarTexts.forEach((text) => {
              text.classList.toggle("hidden");
            });
          });
        }

        const userMenuButton = document.getElementById("user-menu-button");
        const userMenu = document.getElementById("user-menu");

        if (userMenuButton && userMenu) {
          userMenuButton.addEventListener("click", (event) => {
            userMenu.classList.toggle("hidden");
            event.stopPropagation();
          });

          document.addEventListener("click", (event) => {
            if (
              !userMenu.classList.contains("hidden") &&
              !userMenuButton.contains(event.target) &&
              !userMenu.contains(event.target)
            ) {
              userMenu.classList.add("hidden");
            }
          });
        }
      });

      // --- FORM STEP NAVIGATION AND DATA COLLECTION ---
      let currentStep = 1;
      const formData = {
        sections: {},
      };
      // --- ADDED: Global variable to hold the final paper data for saving ---
      let fullPaperPayload = {};

      function showStep(step) {
        document.querySelectorAll("[id^='step-']").forEach((el) => {
          el.classList.add("step-hidden");
          el.classList.remove("step-active");
        });
        const activeStep = document.getElementById(`step-${step}`);
        if (activeStep) {
          setTimeout(() => {
            activeStep.classList.remove("step-hidden");
            activeStep.classList.add("step-active");
          }, 50);
        }
      }

      function collectStepData(step) {
        if (step === 1) {
          formData.jobTitle = document.getElementById("jobTitle").value;
          formData.department = document.getElementById("department").value;
          formData.skills = document.getElementById("skills").value;
          formData.minExp = document.getElementById("minExp").value;
          formData.maxExp = document.getElementById("maxExp").value;
        } else if (step === 2) {
          formData.sections = {};
          document.querySelectorAll("#step-2 [data-section]").forEach((div) => {
            const sectionName = div.dataset.section;
            const count = div.querySelector("input").value;
            if (parseInt(count, 10) > 0) {
              formData.sections[sectionName] = parseInt(count, 10);
            }
          });
          formData.duration = document.getElementById("duration").value;
        }
      }

      function populateReview() {
        document.getElementById("review-jobTitle").textContent =
          formData.jobTitle || "N/A";
        document.getElementById("review-department").textContent =
          formData.department || "N/A";
        document.getElementById("review-duration").textContent =
          formData.duration ? `${formData.duration} minutes` : "N/A";
        document.getElementById("review-experience").textContent =
          formData.minExp && formData.maxExp
            ? `${formData.minExp} - ${formData.maxExp} years`
            : "N/A";

        const skillsContainer = document.getElementById("review-skills");
        skillsContainer.innerHTML = "";
        if (formData.skills) {
          formData.skills.split(",").forEach((skill) => {
            if (skill.trim()) {
              const skillTag = document.createElement("span");
              skillTag.className =
                "bg-slate-200 text-slate-700 text-sm font-medium px-3 py-1 rounded-full";
              skillTag.textContent = skill.trim();
              skillsContainer.appendChild(skillTag);
            }
          });
        }

        const sectionsContainer = document.getElementById("review-sections");
        sectionsContainer.innerHTML = "";
        let totalQuestions = 0;
        for (const section in formData.sections) {
          const count = formData.sections[section];
          totalQuestions += count;
          const sectionDiv = document.createElement("div");
          sectionDiv.className =
            "flex justify-between items-center text-slate-700";
          sectionDiv.innerHTML = `
            <span>${section}</span>
            <span class="font-medium bg-slate-100 text-slate-600 text-xs px-2.5 py-1 rounded-full">${count} Questions</span>
          `;
          sectionsContainer.appendChild(sectionDiv);
        }
        document.getElementById(
          "review-total"
        ).textContent = `${totalQuestions}`;
      }

      function nextStep() {
        collectStepData(currentStep);
        if (currentStep < 3) {
          currentStep++;
          if (currentStep === 3) {
            populateReview();
          }
          showStep(currentStep);
        }
      }

      function prevStep() {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      }

      function updateCount(button, change) {
        const input = button.parentElement.querySelector("input");
        let currentValue = parseInt(input.value, 10);
        let newValue = currentValue + change;
        if (newValue < 0) {
          newValue = 0;
        }
        input.value = newValue;
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // --- MODIFIED: AI GENERATION LOGIC ---
      async function generatePaper() {
        const generateButton = document.querySelector(
          '#step-3 button[onclick="generatePaper()"]'
        );
        generateButton.disabled = true;
        generateButton.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Generating...
        `;

        // This is the user input data that the AI needs
        const aiPostData = {
          job_title: formData.jobTitle,
          min_exp: formData.minExp,
          max_exp: formData.maxExp,
          skills: formData.skills,
          sections: formData.sections,
        };

        try {
          const response = await fetch("{% url 'generate_questions' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(aiPostData),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Server error: ${response.status} ${response.statusText}. Response: ${errorText}`
            );
          }
          const paperData = await response.json(); // This is the AI-generated part
          if (paperData.error) {
            throw new Error(paperData.error);
          }

          // --- CRITICAL STEP: Combine user input with AI output for saving ---
          fullPaperPayload = {
            job_title: formData.jobTitle,
            department: formData.department,
            skills: formData.skills,
            min_exp: formData.minExp,
            max_exp: formData.maxExp,
            duration: formData.duration,
            title: paperData.title, // Title from AI
            sections: paperData.sections, // Detailed sections with questions from AI
          };

          displayGeneratedPaper(paperData);
        } catch (error) {
          console.error("Failed to generate paper:", error);
          alert(`An error occurred: ${error.message}`);
        } finally {
          generateButton.disabled = false;
          generateButton.innerHTML = "Generate";
        }
      }

      function displayGeneratedPaper(paperData) {
        document.getElementById("form-container").classList.add("hidden");
        const paperContainer = document.getElementById("paper-container");
        paperContainer.classList.remove("hidden");

        // Use the combined payload for display to ensure consistency
        document.getElementById("paper-header").textContent =
          fullPaperPayload.title || `${fullPaperPayload.job_title} Assessment`;
        document.getElementById("paper-jobTitle").textContent =
          fullPaperPayload.job_title;
        document.getElementById("paper-department").textContent =
          fullPaperPayload.department;
        document.getElementById(
          "paper-duration"
        ).textContent = `${fullPaperPayload.duration} minutes`;
        document.getElementById(
          "paper-experience"
        ).textContent = `${fullPaperPayload.min_exp} - ${fullPaperPayload.max_exp} years`;

        const skillsContainer = document.getElementById("paper-skills");
        skillsContainer.innerHTML = "";
        if (fullPaperPayload.skills) {
          fullPaperPayload.skills.split(",").forEach((skill) => {
            if (skill.trim()) {
              const skillTag = document.createElement("span");
              skillTag.className =
                "bg-slate-200 text-slate-700 text-sm font-medium px-3 py-1 rounded-full";
              skillTag.textContent = skill.trim();
              skillsContainer.appendChild(skillTag);
            }
          });
        }
        const questionsContainer = document.getElementById("paper-questions");
        questionsContainer.innerHTML = "";

        let questionCounter = 1;
        if (paperData.sections && paperData.sections.length > 0) {
          paperData.sections.forEach((section) => {
            const sectionTitle = document.createElement("h3");
            sectionTitle.className =
              "text-xl font-bold text-slate-700 mt-8 -mb-4 border-b pb-2";
            sectionTitle.textContent = section.title;
            questionsContainer.appendChild(sectionTitle);

            section.questions.forEach((q) => {
              const questionDiv = document.createElement("div");
              questionDiv.className =
                "bg-white p-6 rounded-lg border border-slate-200";

              let optionsHtml = "";
              if (
                q.options &&
                Array.isArray(q.options) &&
                q.options.length > 0
              ) {
                optionsHtml =
                  '<ul class="list-disc list-inside mt-2 space-y-1 text-slate-600">';
                q.options.forEach((opt) => {
                  optionsHtml += `<li>${opt}</li>`;
                });
                optionsHtml += "</ul>";
              }

              questionDiv.innerHTML = `
                        <p class="font-semibold text-slate-800 flex items-start">
                            <span class="mr-2">${questionCounter}.</span>
                            <span>${q.text}</span>
                        </p>
                        ${optionsHtml}
                        <div class="mt-3 pt-3 pl-6 border-l-2 border-[#736b8e] ml-1">
                            <p class="text-slate-600">
                                <span class="font-medium text-slate-700">Answer:</span>
                                ${q.answer}
                            </p>
                        </div>
                    `;
              questionsContainer.appendChild(questionDiv);
              questionCounter++;
            });
          });
        } else {
          questionsContainer.innerHTML =
            '<p class="text-red-500">The AI could not generate questions based on the provided input. Please check your parameters and try again.</p>';
        }
      }

      // File: generator.html (Inside the <script> tag)

      // --- ADDED: Function to save the generated paper ---
      async function savePaper() {
        const saveButton = document.querySelector(
          '#paper-container button[onclick^="savePaper"]'
        );
        saveButton.disabled = true;
        saveButton.innerHTML = `
      <svg class="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
      Saving...`;

        try {
          const response = await fetch("{% url 'save_paper' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(fullPaperPayload), // Sends the complete paper data
          });

          const result = await response.json();

          if (!response.ok || !result.success) {
            throw new Error(result.error || "Failed to save the paper.");
          }
          console.log(response);
          alert(result.message); // Show success message
          // Redirect to the URL sent from the backend (e.g., '/dashboard/')
          window.location.href = result.redirect_url;
        } catch (error) {
          console.error("Save error:", error);
          alert(`Could not save the paper: ${error.message}`);
        } finally {
          saveButton.disabled = false;
          saveButton.textContent = "Save";
        }
      }
    </script>
  </body>
</html> -->